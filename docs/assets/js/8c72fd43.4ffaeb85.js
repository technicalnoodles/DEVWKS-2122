"use strict";(self.webpackChunkdevwks_2122_docs=self.webpackChunkdevwks_2122_docs||[]).push([[157],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>h});var o=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,o,a=function(e,n){if(null==e)return{};var t,o,a={},s=Object.keys(e);for(o=0;o<s.length;o++)t=s[o],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(o=0;o<s.length;o++)t=s[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=o.createContext({}),p=function(e){var n=o.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=p(e.components);return o.createElement(l.Provider,{value:n},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},u=o.forwardRef((function(e,n){var t=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),c=p(t),u=a,h=c["".concat(l,".").concat(u)]||c[u]||m[u]||s;return t?o.createElement(h,i(i({ref:n},d),{},{components:t})):o.createElement(h,i({ref:n},d))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var s=t.length,i=new Array(s);i[0]=u;var r={};for(var l in n)hasOwnProperty.call(n,l)&&(r[l]=n[l]);r.originalType=e,r[c]="string"==typeof e?e:a,i[1]=r;for(var p=2;p<s;p++)i[p]=t[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}u.displayName="MDXCreateElement"},8389:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>s,metadata:()=>r,toc:()=>p});var o=t(7462),a=(t(7294),t(3905));const s={sidebar_position:5},i="MongoDb Part 1",r={unversionedId:"mongodb-1",id:"mongodb-1",title:"MongoDb Part 1",description:"Mongo is the database this application uses to store data. It has events that we can create or remove, and it will hold the user information we get back from WebEx.",source:"@site/docs/mongodb-1.mdx",sourceDirName:".",slug:"/mongodb-1",permalink:"/DEVWKS-2122/mongodb-1",draft:!1,editUrl:"https://cisco.com/docs/mongodb-1.mdx",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Passport Part 1",permalink:"/DEVWKS-2122/passport-install"},next:{title:"Passport Part 2",permalink:"/DEVWKS-2122/passport-p-2"}},l={},p=[{value:"Creating a User model",id:"creating-a-user-model",level:2},{value:"Update Passport services",id:"update-passport-services",level:2},{value:"Update index.js",id:"update-indexjs",level:2}],d={toc:p};function c(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,o.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"mongodb-part-1"},"MongoDb Part 1"),(0,a.kt)("p",null,"Mongo is the database this application uses to store data. It has events that we can create or remove, and it will hold the user information we get back from WebEx."),(0,a.kt)("p",null,"This workshop uses a library called ",(0,a.kt)("inlineCode",{parentName:"p"},"Mongoose")," to handle connecting and doing database operations for us. We will not need to install this library as it is already installed and being used to store events."),(0,a.kt)("p",null,"In the ",(0,a.kt)("inlineCode",{parentName:"p"},"index.js"),", we can see the few lines that mention Mongoose."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=index.js showLineNumbers",title:"index.js",showLineNumbers:!0},"const express = require('express');\n//highlight-next-line\nconst mongoose = require('mongoose');\nrequire('./services/passport');\nrequire('./models/Event');\n\nconst port = 5000;\n\nmain().catch((err) => console.log(err));\n//highlight-next-line\nasync function main() {\n  //highlight-next-line\n  await mongoose.connect('mongodb://localhost:27017');\n  //highlight-next-line\n  // use `await mongoose.connect('mongodb://user:password@localhost:27017/test');` if your database has auth enabled\n  //highlight-next-line\n}\n\nconst app = express();\napp.use(express.json());\nrequire('./routes/authRoutes')(app);\n\nrequire('./routes/eventRoutes')(app);\n\napp.listen(port, () => {\n  console.log(`Example app listening on port ${port}`);\n});\n")),(0,a.kt)("p",null,"At the top of the file, we import Mongoose using a require statement. A little further down, we have an async function that waits for mongoose to connect the Mongo database. This line is prefilled with the Mongo URI that we will use to connect to the database."),(0,a.kt)("p",null,"The rest of the Mongoose components we need to control data is in this line:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"require('./routes/eventRoutes')(app);\n")),(0,a.kt)("p",null,"In the ",(0,a.kt)("inlineCode",{parentName:"p"},"routes.eventRoutes.js")," file, there is one line at the top that we want to look at."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const Event = mongoose.model('event');\n")),(0,a.kt)("p",null,"This line above references a ",(0,a.kt)("inlineCode",{parentName:"p"},"model"),". Mongoose uses ",(0,a.kt)("inlineCode",{parentName:"p"},"models")," to interact with the database. Each ",(0,a.kt)("inlineCode",{parentName:"p"},"model")," is the format of one entry in the database. We can use this model to query a specific collection of data by doing an update, reading, and writing to that collection of data. The ",(0,a.kt)("inlineCode",{parentName:"p"},"model")," will contain all the information needed to make those queries. It is good to note, that each ",(0,a.kt)("inlineCode",{parentName:"p"},"model")," corresponds to one collection in the Mongo database."),(0,a.kt)("p",null,"In the ",(0,a.kt)("inlineCode",{parentName:"p"},"/models/Event.js")," file, we can see how a ",(0,a.kt)("inlineCode",{parentName:"p"},"model")," is formatted:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=models/Event.js showLineNumbers",title:"models/Event.js",showLineNumbers:!0},"const mongoose = require('mongoose');\nconst { Schema } = mongoose;\n\nconst eventSchema = new Schema({\n  title: String, // String is shorthand for {type: String}\n  active: Boolean,\n});\n\nconst event = mongoose.model('event', eventSchema);\n")),(0,a.kt)("p",null,"In the code of the ",(0,a.kt)("inlineCode",{parentName:"p"},"Event.js")," file, we can see it imports ",(0,a.kt)("inlineCode",{parentName:"p"},"Schema")," from Mongoose. A ",(0,a.kt)("inlineCode",{parentName:"p"},"Schema")," is the blueprint for the ",(0,a.kt)("inlineCode",{parentName:"p"},"model"),". The ",(0,a.kt)("inlineCode",{parentName:"p"},"Schema")," for this model only has two properties: a string called ",(0,a.kt)("inlineCode",{parentName:"p"},"title")," and a Boolean called ",(0,a.kt)("inlineCode",{parentName:"p"},"active"),". These are the default fields that are always required when you want to create a new event.  "),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"This does not mean we cannot add more data to an event though. We can add as many properties as we want, but those two must be included.  ")),(0,a.kt)("p",null,"After the ",(0,a.kt)("inlineCode",{parentName:"p"},"Schema")," has been created, we can create a ",(0,a.kt)("inlineCode",{parentName:"p"},"model")," out of it. The ",(0,a.kt)("inlineCode",{parentName:"p"},"mongoose.model")," function takes two arguments. The first argument is the name of the collection (in this case, ",(0,a.kt)("inlineCode",{parentName:"p"},"event"),") and the second is the ",(0,a.kt)("inlineCode",{parentName:"p"},"schema")," that was created (",(0,a.kt)("inlineCode",{parentName:"p"},"eventSchema"),"). When the ",(0,a.kt)("inlineCode",{parentName:"p"},"mongoose.model")," is called, it will create a new collection called ",(0,a.kt)("inlineCode",{parentName:"p"},"event")," and the ",(0,a.kt)("inlineCode",{parentName:"p"},"Schema")," is the interface to accessing the collection.  "),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"If there is already a collection in the database called ",(0,a.kt)("inlineCode",{parentName:"p"},"event"),", Mongoose will not recreate the ",(0,a.kt)("inlineCode",{parentName:"p"},"event")," collection.")),(0,a.kt)("p",null,"We have looked at some examples of what we will be doing, but now we need to create a ",(0,a.kt)("inlineCode",{parentName:"p"},"user")," model."),(0,a.kt)("h2",{id:"creating-a-user-model"},"Creating a User model"),(0,a.kt)("p",null,"In the ",(0,a.kt)("inlineCode",{parentName:"p"},"models")," directory, we need to create a new file called ",(0,a.kt)("inlineCode",{parentName:"p"},"User.js")),(0,a.kt)("p",null,"After it is created, open the ",(0,a.kt)("inlineCode",{parentName:"p"},"User.js")," file in the code editor. We need to do our initial imports like in the ",(0,a.kt)("inlineCode",{parentName:"p"},"Event")," model:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=models/User.js showLineNumbers",title:"models/User.js",showLineNumbers:!0},"//add-line\nconst mongoose = require('mongoose');\n//add-line\nconst { Schema } = mongoose;\n")),(0,a.kt)("p",null,"After importing Mongoose and pulling out the ",(0,a.kt)("inlineCode",{parentName:"p"},"Schema")," function, we can create our ",(0,a.kt)("inlineCode",{parentName:"p"},"userSchema"),". The ",(0,a.kt)("inlineCode",{parentName:"p"},"userSchema")," will contain three properties: ",(0,a.kt)("inlineCode",{parentName:"p"},"ciscoId"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"name"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"departmentId"),". These will all be values we store after the authentication flow has finished."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=models/User.js showLineNumbers",title:"models/User.js",showLineNumbers:!0},"const mongoose = require('mongoose');\nconst { Schema } = mongoose;\n//add-line\nconst userSchema = new Schema({\n  //add-line\n  ciscoId: String,\n  //add-line\n  name: String,\n  //add-line\n  departmentId: String,\n  //add-line\n});\n")),(0,a.kt)("p",null,"We now need to call ",(0,a.kt)("inlineCode",{parentName:"p"},"model")," function to create a new collection called ",(0,a.kt)("inlineCode",{parentName:"p"},"users")," and to create an interface with the ",(0,a.kt)("inlineCode",{parentName:"p"},"userSchema"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=models/User.js showLineNumbers",title:"models/User.js",showLineNumbers:!0},"const mongoose = require('mongoose');\nconst { Schema } = mongoose;\nconst userSchema = new Schema({\n  ciscoId: String,\n  name: String,\n  departmentId: String,\n});\n\n//add-line\nmongoose.model('users', userSchema);\n")),(0,a.kt)("p",null,"Let's update the Passport service to use the model we created."),(0,a.kt)("h2",{id:"update-passport-services"},"Update Passport services"),(0,a.kt)("p",null,"We need to first import Mongoose and then set the ",(0,a.kt)("inlineCode",{parentName:"p"},"user")," model to a variable. We will remove the two console logs as well since we no longer need them."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=services/passport.js showLineNumbers",title:"services/passport.js",showLineNumbers:!0},"const passport = require('passport');\nconst CiscoStrategy = require('passport-cisco-spark').Strategy;\n//add-line\nconst mongoose = require('mongoose');\nconst keys = require('../config/keys');\n//add-line\nconst User = mongoose.model('users');\n\npassport.use(\n  new CiscoStrategy(\n    {\n      clientID: keys.ciscoClientID,\n      clientSecret: keys.ciscoClientSecret,\n      callbackURL: '/auth/cisco/callback',\n    },\n    (accessToken, refreshToken, profile, done) => {\n      //remove-line\n      console.log(accessToken);\n      //remove-line\n      console.log(profile);\n    }\n  )\n);\n")),(0,a.kt)("p",null,"Next we need to add some logic to ",(0,a.kt)("inlineCode",{parentName:"p"},"CiscoStrategy")," callback function. In this callback function we will use the ",(0,a.kt)("inlineCode",{parentName:"p"},"User")," model to check if the user logging in already exists using ",(0,a.kt)("inlineCode",{parentName:"p"},".findOne"),". If they do exist, it will tell the flow to continue using the ",(0,a.kt)("inlineCode",{parentName:"p"},"done")," function that is provided."),(0,a.kt)("p",null,"In a ",(0,a.kt)("inlineCode",{parentName:"p"},"done")," function, to say the flow has happened as expected and to continue, we need to pass it an argument of ",(0,a.kt)("inlineCode",{parentName:"p"},"null")," and a second argument of the user that was found."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=services/passport.js showLineNumbers",title:"services/passport.js",showLineNumbers:!0},"const passport = require('passport');\nconst CiscoStrategy = require('passport-cisco-spark').Strategy;\nconst mongoose = require('mongoose');\nconst keys = require('../config/keys');\nconst User = mongoose.model('users');\n\npassport.use(\n  new CiscoStrategy(\n    {\n      clientID: keys.ciscoClientID,\n      clientSecret: keys.ciscoClientSecret,\n      callbackURL: '/auth/cisco/callback',\n    },\n    (accessToken, refreshToken, profile, done) => {\n      //add-line\n      User.findOne({\n        //add-line\n        ciscoId: profile.userName,\n        //add-line\n      }).then((existingUser) => {\n        //add-line\n        if (existingUser) {\n          //add-line\n          done(null, existingUser);\n          //add-line\n        }\n        //add-line\n      });\n    }\n  )\n);\n")),(0,a.kt)("p",null,"If this user does not exist, an ",(0,a.kt)("inlineCode",{parentName:"p"},"else")," statement will be used to ",(0,a.kt)("inlineCode",{parentName:"p"},"save")," the new user into the database using the three properties we specified in the model. We then need to tell Passport the flow went as expected using the ",(0,a.kt)("inlineCode",{parentName:"p"},"done")," function; passing the ",(0,a.kt)("inlineCode",{parentName:"p"},"null")," property and the new ",(0,a.kt)("inlineCode",{parentName:"p"},"user"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=services/passport.js showLineNumbers",title:"services/passport.js",showLineNumbers:!0},"const passport = require('passport');\nconst CiscoStrategy = require('passport-cisco-spark').Strategy;\nconst mongoose = require('mongoose');\nconst keys = require('../config/keys');\nconst User = mongoose.model('users');\n\npassport.use(\n  new CiscoStrategy(\n    {\n      clientID: keys.ciscoClientID,\n      clientSecret: keys.ciscoClientSecret,\n      callbackURL: '/auth/cisco/callback',\n    },\n    (accessToken, refreshToken, profile, done) => {\n      User.findOne({\n        ciscoId: profile.userName,\n      }).then((existingUser) => {\n        if (existingUser) {\n          done(null, existingUser);\n          //add-line\n        } else {\n          //add-line\n          new User({\n            //add-line\n            ciscoId: profile['_json']['userName'],\n            //add-line\n            name: profile['displayname'],\n            //add-line\n            departmentId: profile['_json']['department'],\n            //add-line\n          })\n            //add-line\n            .save()\n            //add-line\n            .then((user) => done(null, user));\n          //add-line\n        }\n      });\n    }\n  )\n);\n")),(0,a.kt)("p",null,"We have finished the logic needed to add a user to the database, but we are not able to use this until we have imported the model into ",(0,a.kt)("inlineCode",{parentName:"p"},"index.js")),(0,a.kt)("h2",{id:"update-indexjs"},"Update index.js"),(0,a.kt)("p",null,"We need to add one line to our ",(0,a.kt)("inlineCode",{parentName:"p"},"index.js")," file. That line is importing the ",(0,a.kt)("inlineCode",{parentName:"p"},"user")," model. The entire application can now use it after being imported."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript",metastring:"title=index.js showLineNumbers",title:"index.js",showLineNumbers:!0},"const express = require('express');\nconst mongoose = require('mongoose');\n//add-line\nrequire('./models/User');\nrequire('./services/passport');\nrequire('./models/Event');\n\nconst port = 5000;\n\nmain().catch((err) => console.log(err));\n\nasync function main() {\n  await mongoose.connect('mongodb://localhost:27017');\n  // use `await mongoose.connect('mongodb://user:password@localhost:27017/test');` if your database has auth enabled\n}\n\nconst app = express();\napp.use(express.json());\nrequire('./routes/authRoutes')(app);\n\nrequire('./routes/eventRoutes')(app);\n\napp.listen(port, () => {\n  console.log(`Example app listening on port ${port}`);\n});\n")),(0,a.kt)("admonition",{type:"danger"},(0,a.kt)("p",{parentName:"admonition"},"Order of operations matter when it comes to requiring libraries and models. Since our Passport service needs to use the ",(0,a.kt)("inlineCode",{parentName:"p"},"User")," model, we need to import the model after mongoose but before the passport service.")),(0,a.kt)("p",null,"We have finished the MongoDb portion of the workshop. We will return to working with Passport now."))}c.isMDXComponent=!0}}]);