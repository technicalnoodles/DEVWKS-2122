---
sidebar_position: 2
---

# Creating Cookies and Testing

## Creating a Session Cookie

To create a cookie for our users. We need to tell Passport to use a cookie and to do this we need the library called `cookie-session`.

### Update Passport to Use a Cookie

Open the `index.js` from the root directory in VSCode. The below code should be pasted into that file:

```javascript title=index.js showLineNumbers
const express = require('express');
const mongoose = require('mongoose');
const cookieSession = require('cookie-session');
const passport = require('passport');
const keys = require('./config/keys');
require('./models/User');
require('./services/passport');
require('./models/Event');

const port = 5000;

main().catch((err) => console.log(err));

async function main() {
  await mongoose.connect('mongodb://localhost:27017');
  // use `await mongoose.connect('mongodb://user:password@localhost:27017/test');` if your database has auth enabled
}

const app = express();
app.use(express.json());

app.use(
  cookieSession({
    maxAge: 2 * 24 * 60 * 60 * 1000,
    keys: [keys.cookieKey],
  })
);

app.use(function (request, response, next) {
  if (request.session && !request.session.regenerate) {
    request.session.regenerate = (cb) => {
      cb();
    };
  }
  if (request.session && !request.session.save) {
    request.session.save = (cb) => {
      cb();
    };
  }
  next();
});

app.use(passport.initialize());
app.use(passport.session());

require('./routes/authRoutes')(app);

require('./routes/eventRoutes')(app);

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

In the code above we import the Passport service, User model, cookieSession library, and Passport. We then tell the `app` to use the `cookieSession` library. `cookieSession` takes an object as an argument. The object has two properties in it: `maxAge` and `keys`. The `maxAge` property is the amount of time a cookie has before it expires in milliseconds. The `keys` property is a list of keys that can be used to encrypt the session cookie.

Then we need to tell Passport to use the cookie in a session. This is done with only two additional lines. The `initialize` function tells passport to use the `serialize` and `deserialize` functions we defined earlier. The `session` function tells passport to use sessions after an authentication flow completes.

### Testing

To test that our flow works; in a browser, go to `localhost:5000/auth/cisco`. It should take you to a login and ask for permission to give the app your info. After this, it will redirect to `/event` on the frontend.

If you check the CLI there should be some json data. This is the profile we logged out in the Passport service and is the raw user data before we parsed through it to store only some parts of it. It should look like what is below:

```json showLineNumber
{
    provider: 'cisco-spark',
    id: 'Y2lzYOWE',
    displayName: 'Ryan MacLennan',
    emails: [ 'rymaclen@cisco.com' ],
    avatar: 'https://63cd9a~9a06f454eaf94e439575028d59b2b171~1600',
    created: '1900-06-21',
    _json: {
        id: 'Y2lzY22NkOWE',
        emails: [ 'rymaclen@cisco.com' ],
        phoneNumbers: [ [Object], [Object] ],
        displayName: 'Ryan MacLennan',
        nickName: 'Ryan',
        firstName: 'Ryan',
        lastName: 'MacLennan',
        userName: 'rymaclen@cisco.com',
        avatar: 'https://avatar-prod-us-east-2.webexcontent.com/06f454eaf94e439575028d59b2b171~1600',
        orgId: 'OSVpBVElPTi8xZWI2NWZkZi05NjQ',
        created: '1900-06-21',
        lastModified: '2023-01-11T17:57:33.357Z',
        lastActivity: '2023-01-17T23:04:20.927Z',
        status: 'active',
        type: 'person',
        department: '0',
        title: 'Technical Marketing Engineer',
    }
}
```

You may have noticed that the top right of the frontend still says **login**. Were we actualy authenticated or not? We can check that by going to the `current_user` route we created. This will only show data is there is a user logged in. Go to `localhost:5000/api/current_user`. It should return the data for our user.

Now lets logout and test this again. Go to `localhost:5000/api/logout`, then back to `localhost:5000/api/current_user`.

The logout should return you the frontend and it will still say login. But checking the `localhost:5000/api/current_user` route will return a blank screen. Now we know that our authentication flow works and we are able to successfully create and teardown a session.

In the next section we will create a middleware that will intercept requests and check if a user is logged in.
