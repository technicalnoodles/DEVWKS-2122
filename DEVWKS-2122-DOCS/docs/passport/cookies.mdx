---
sidebar_position: 6
---

# Creating Cookies

## Creating a Session Cookie

To create a cookie for our users. We need to tell Passport to use a cookie and to do this we need the library called `cookie-session`.

### Create a Cookie Encryption Key

We need to update the `keys.js` file after it has finished installing. Open the `keys.js` file in the `config` directory. We need to add a new property to the object in this file called `cookieKey`. This object will be used as the encryption key for the cookie. This is an example of what the file should look after adding the `cookieKey` property.

```javascript title=config/keys.js showLineNumbers
module.exports({
  ciscoClientID: 'asdfasdfasd',
  ciscoClientSecret: 'sdfgasdfa',
  //add-line
  cookieKey: 'randomstring',
});
```

### Update Passport to Use a Cookie

Open the `index.js` in VSCode.

```javascript title=index.js showLineNumbers
const express = require('express');
const mongoose = require('mongoose');
const cookieSession = require('cookie-session');
const passport = require('passport');
const keys = require('./config/keys');
require('./models/User');
require('./services/passport');
require('./models/Event');

const port = 5000;

main().catch((err) => console.log(err));

async function main() {
  await mongoose.connect('mongodb://localhost:27017');
  // use `await mongoose.connect('mongodb://user:password@localhost:27017/test');` if your database has auth enabled
}

const app = express();
app.use(express.json());

app.use(
  cookieSession({
    maxAge: 2 * 24 * 60 * 60 * 1000,
    keys: [keys.cookieKey],
  })
);

app.use(function (request, response, next) {
  if (request.session && !request.session.regenerate) {
    request.session.regenerate = (cb) => {
      cb();
    };
  }
  if (request.session && !request.session.save) {
    request.session.save = (cb) => {
      cb();
    };
  }
  next();
});

app.use(passport.initialize());
app.use(passport.session());

require('./routes/authRoutes')(app);

require('./routes/eventRoutes')(app);

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

In the code above we we import and tell the `app` to use the `cookieSession` library. `cookieSession` takes an object as an argument. The object has two properties in it: `maxAge` and `keys`. The `maxAge` property is the amount of time a cookie has before it expires in milliseconds. The `keys` property is a list of keys that can be used to encrypt the session cookie.

Lastly we need to tell Passport to use the cookie in a session. This is done with only two additional lines. The `initialize` function tells passport to use the `serialize` and `deserialize` functions we defined earlier. The `session` function tells passport to use sessions after an authentication flow completes.

### Testing

To test that our flow works, we can run `index.js`. Run the command `node index.js` and it will start the server. In a browser, go to `localhost:5000/auth/cisco`. It should take you to a login and ask for permission to give the app your info. After this, it will hang and never load a new page. Check the CLI and there should now be some json data. This is the profile we logged out in the Passport service. It should look like what is below:

```json showLineNumber
{
    provider: 'cisco-spark',
    id: 'Y2lzYOWE',
    displayName: 'Ryan MacLennan',
    emails: [ 'rymaclen@cisco.com' ],
    avatar: 'https://63cd9a~9a06f454eaf94e439575028d59b2b171~1600',
    created: '1900-06-21',
    _json: {
        id: 'Y2lzY22NkOWE',
        emails: [ 'rymaclen@cisco.com' ],
        phoneNumbers: [ [Object], [Object] ],
        displayName: 'Ryan MacLennan',
        nickName: 'Ryan',
        firstName: 'Ryan',
        lastName: 'MacLennan',
        userName: 'rymaclen@cisco.com',
        avatar: 'https://avatar-prod-us-east-2.webexcontent.com/06f454eaf94e439575028d59b2b171~1600',
        orgId: 'OSVpBVElPTi8xZWI2NWZkZi05NjQ',
        created: '1900-06-21',
        lastModified: '2023-01-11T17:57:33.357Z',
        lastActivity: '2023-01-17T23:04:20.927Z',
        status: 'active',
        type: 'person',
        department: '0',
        title: 'Technical Marketing Engineer',
    }
}
```

We can try running the `index.js` file now. To do this run the below command:

`node index.js`

Then attempt to authenticate using the below URL:

`localhost:5000/auth/cisco`

It should ask for a login and permissions.
